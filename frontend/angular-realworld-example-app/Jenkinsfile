node {
   def commit_id
   stage('Preparation') {
     checkout scm
     sh "git rev-parse --short HEAD > .git/commit-id"                        
     commit_id = readFile('.git/commit-id').trim()
    }  
   stage('Docker build/push') {     
     docker.withRegistry('https://index.docker.io/v1/', 'docker-gurpritsingh') {
       def app = docker.build("gurpritsingh/angularrealworldfrontend:${env.BUILD_NUMBER}", '.').push()
      }
     docker.withRegistry('https://index.docker.io/v1/', 'docker-gurpritsingh') {
       def app = docker.build("gurpritsingh/angularrealworldfrontend:${commit_id}", '.').push()
      }
    }
   stage('Deploy to App Service') {
        withCredentials([azureServicePrincipal('Devops-free-trial-subs'), string(credentialsId: 'docker-gurpritsingh-password', variable: 'dockerPassword')]) {
          echo "Deploying to azure app service"
          sh """
              resourceGroup='amitRG-dev'
              deploymentName='angularrealworldfrontend'
              cd armTemplates
              az login --service-principal --username ${AZURE_CLIENT_ID} --password ${AZURE_CLIENT_SECRET} --tenant ${AZURE_TENANT_ID} # --subscription ${AZURE_SUBSCRIPTION_ID}
              az group create -l eastus2 -n \$resourceGroup --subscription ${AZURE_SUBSCRIPTION_ID}
              az deployment group create --resource-group \$resourceGroup  --name \$deploymentName --template-file azureDeploy.json --parameters dev.parameters.json --parameters dockerRegistryPassword=${dockerPassword} --parameters linuxFxVersion="DOCKER|gurpritsingh/angularrealworldfrontend:${env.BUILD_NUMBER}"
            """
          }
      }
  }

